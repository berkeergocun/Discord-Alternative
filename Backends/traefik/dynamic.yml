# Traefik Dynamic Configuration

http:
  routers:
    # Auth Service (API v1)
    auth-service:
      rule: "Host(`localhost`) && PathPrefix(`/api/v1/auth`)"
      service: auth-service
      entryPoints:
        - web
      middlewares:
        - strip-api-v1-prefix

    # User @me/channels -> Message Service (PathRegexp - @ sembolü PathPrefix'te çalışmıyor)
    user-me-channels:
      rule: "Host(`localhost`) && PathRegexp(`^/api/v1/users/[^/]+/channels`)"
      service: message-service
      entryPoints:
        - web
      priority: 20
      middlewares:
        - strip-api-v1-prefix

    # User Service (API v1)
    user-service:
      rule: "Host(`localhost`) && PathPrefix(`/api/v1/users`)"
      service: user-service
      entryPoints:
        - web
      priority: 10
      middlewares:
        - strip-api-v1-prefix

    # Guild Service (API v1)
    guild-service:
      rule: "Host(`localhost`) && PathPrefix(`/api/v1/guilds`)"
      service: guild-service
      entryPoints:
        - web
      middlewares:
        - strip-api-v1-prefix

    # Message Service (API v1)
    message-service:
      rule: "Host(`localhost`) && PathPrefix(`/api/v1/messages`)"
      service: message-service
      entryPoints:
        - web
      middlewares:
        - strip-api-v1-prefix

    # Channels endpoint (API v1)
    channels-service:
      rule: "Host(`localhost`) && PathPrefix(`/api/v1/channels`)"
      service: message-service
      entryPoints:
        - web
      middlewares:
        - strip-api-v1-prefix

    # WebSocket Gateway (API v1)
    websocket-gateway:
      rule: "Host(`localhost`) && PathPrefix(`/api/v1/ws`)"
      service: websocket-gateway
      entryPoints:
        - web
      middlewares:
        - strip-api-v1-prefix

    # WebSocket doğrudan (message-service içinde /ws endpoint)
    websocket-direct:
      rule: "Host(`localhost`) && PathPrefix(`/ws`)"
      service: message-service
      entryPoints:
        - web
      priority: 50

    # SFU Service (API v1)
    sfu-service:
      rule: "Host(`localhost`) && PathPrefix(`/api/v1/sfu`)"
      service: sfu-service
      entryPoints:
        - web
      middlewares:
        - strip-api-v1-prefix

    # Frontend (Nuxt) - Catch all other routes
    frontend:
      rule: "Host(`localhost`)"
      service: frontend
      entryPoints:
        - web
      priority: 1

  services:
    # API Gateway Service
    api-gateway:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3100"
        healthCheck:
          path: /health
          interval: 30s
          timeout: 5s

    # Auth Service
    auth-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3001"
        healthCheck:
          path: /health
          interval: 30s
          timeout: 5s

    # User Service
    user-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3002"
        healthCheck:
          path: /health
          interval: 30s
          timeout: 5s

    # Guild Service
    guild-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3003"
        healthCheck:
          path: /health
          interval: 30s
          timeout: 5s

    # Message Service
    message-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3004"
        healthCheck:
          path: /health
          interval: 30s
          timeout: 5s

    # WebSocket Gateway
    websocket-gateway:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3006"
        healthCheck:
          path: /health
          interval: 30s
          timeout: 5s

    # SFU Service
    sfu-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3007"
        healthCheck:
          path: /health
          interval: 30s
          timeout: 5s

    # Frontend (Nuxt)
    frontend:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3000"

  middlewares:
    # Strip /api/v1 prefix for backend services  
    strip-api-v1-prefix:
      stripPrefixRegex:
        regex:
          - "^/api/v1"

    # CORS Middleware
    cors:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
        accessControlAllowOriginList:
          - "*"
        accessControlAllowHeaders:
          - "*"
        accessControlMaxAge: 100
        addVaryHeader: true

    # Rate Limiting
    rate-limit:
      rateLimit:
        average: 100
        burst: 200
        period: 1s
